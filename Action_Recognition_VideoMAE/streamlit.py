import streamlit as st
from transformers import VideoMAEFeatureExtractor, VideoMAEForVideoClassification
import torch
import youtube_dl
# decord is a faster alternative of opencv
from decord import VideoReader, cpu 
import numpy as np
import os

# load videomae model from hugging face
feature_extractor = VideoMAEFeatureExtractor.from_pretrained("MCG-NJU/videomae-base-finetuned-kinetics")
model = VideoMAEForVideoClassification.from_pretrained("MCG-NJU/videomae-base-finetuned-kinetics")
device = "cuda" if torch.cuda.is_available() else "cpu"
model.to(device)

# outline
st.title("Action Recognition")
st.write("Github link: [github/erjieyong](https://github.com/erjieyong/Data_Science_Projects/tree/main/Action_Recognition_VideoMAE)")
with st.sidebar:
  st.subheader("List of predictable classes")
  st.write("""
  1. abseiling (1146)
2. air drumming (1132)
3. answering questions (478)
4. applauding (411)
5. applying cream (478)
6. archery (1147)
7. arm wrestling (1123)
8. arranging ﬂowers (583)
9. assembling computer (542)
10. auctioning (478)
11. baby waking up (611)
12. baking cookies (927)
13. balloon blowing (826)
14. bandaging (569)
15. barbequing (1070)
16. bartending (601)
17. beatboxing (943)
18. bee keeping (430)
19. belly dancing (1115)
20. bench pressing (1106)
21. bending back (635)
22. bending metal (410)
23. biking through snow (1052)
24. blasting sand (713)
25. blowing glass (1145)
26. blowing leaves (405)
27. blowing nose (597)
28. blowing out candles (1150)
29. bobsledding (605)
30. bookbinding (914)
31. bouncing on trampoline (690)
32. bowling (1079)
33. braiding hair (780)
34. breading or breadcrumbing (454)
35. breakdancing (948)
36. brush painting (532)
37. brushing hair (934)
38. brushing teeth (1149)
39. building cabinet (431)
40. building shed (427)
41. bungee jumping (1056)
42. busking (851)
43. canoeing or kayaking (1146)
44. capoeira (1092)
45. carrying baby (558)
46. cartwheeling (616)
47. carving pumpkin (711)
48. catching ﬁsh (671)
49. catching or throwing baseball (756)
50. catching or throwing frisbee (1060)
51. catching or throwing softball (842)
52. celebrating (751)
53. changing oil (714)
54. changing wheel (459)
55. checking tires (555)
56. cheerleading (1145)
57. chopping wood (916)
58. clapping (491)
59. clay pottery making (513)
60. clean and jerk (902)
61. cleaning ﬂoor (874)
62. cleaning gutters (598)
63. cleaning pool (447)
64. cleaning shoes (706)
65. cleaning toilet (576)
66. cleaning windows (695)
67. climbing a rope (413)
68. climbing ladder (662)
69. climbing tree (1120)
70. contact juggling (1135)
71. cooking chicken (1000)
72. cooking egg (618)
73. cooking on campﬁre (403)
74. cooking sausages (467)
75. counting money (674)
76. country line dancing (1015)
77. cracking neck (449)
78. crawling baby (1150)
79. crossing river (951)
80. crying (1037)
81. curling hair (855)
82. cutting nails (560)
83. cutting pineapple (712)
84. cutting watermelon (767)
85. dancing ballet (1144)
86. dancing charleston (721)
87. dancing gangnam style (836)
88. dancing macarena (958)
89. deadlifting (805)
90. decorating the christmas tree (612)
91. digging (404)
92. dining (671)
93. disc golﬁng (565)
94. diving cliff (1075)
95. dodgeball (595)
96. doing aerobics (461)
97. doing laundry (461)
98. doing nails (949)
99. drawing (445)
100. dribbling basketball (923)
101. drinking (599)
102. drinking beer (575)
103. drinking shots (403)
104. driving car (1118)
105. driving tractor (922)
106. drop kicking (716)
107. drumming ﬁngers (409)
108. dunking basketball (1105)
109. dying hair (1072)
110. eating burger (864)
111. eating cake (494)
112. eating carrots (516)
113. eating chips (749)
114. eating doughnuts (528)
115. eating hotdog (570)
116. eating ice cream (927)
117. eating spaghetti (1145)
118. eating watermelon (550)
119. egg hunting (500)
120. exercising arm (416)
121. exercising with an exercise ball (438)
122. extinguishing ﬁre (602)
123. faceplanting (441)
124. feeding birds (1150)
125. feeding ﬁsh (973)
126. feeding goats (1027)
127. ﬁlling eyebrows (1085)
128. ﬁnger snapping (825)
129. ﬁxing hair (676)
130. ﬂipping pancake (720)
131. ﬂying kite (1063)
132. folding clothes (695)
133. folding napkins (874)
134. folding paper (940)
135. front raises (962)
136. frying vegetables (608)
137. garbage collecting (441)
138. gargling (430)
139. getting a haircut (658)
140. getting a tattoo (737)
141. giving or receiving award (953)
142. golf chipping (699)
143. golf driving (836)
144. golf putting (1081)
145. grinding meat (415)
146. grooming dog (613)
147. grooming horse (645)
148. gymnastics tumbling (1143)
149. hammer throw (1148)
150. headbanging (1090)
151. headbutting (640)
152. high jump (954)
153. high kick (825)
154. hitting baseball (1071)
155. hockey stop (468)
156. holding snake (430)
157. hopscotch (726)
158. hoverboarding (564)
159. hugging (517)
160. hula hooping (1129)
161. hurdling (622)
162. hurling (sport) (836)
163. ice climbing (845)
164. ice ﬁshing (555)
165. ice skating (1140)
166. ironing (535)
167. javelin throw (912)
168. jetskiing (1140)
169. jogging (417)
170. juggling balls (923)
171. juggling ﬁre (668)
172. juggling soccer ball (484)
173. jumping into pool (1133)
174. jumpstyle dancing (662)
175. kicking ﬁeld goal (833)
176. kicking soccer ball (544)
177. kissing (733)
178. kitesurﬁng (794)
179. knitting (691)
180. krumping (657)
181. laughing (926)
182. laying bricks (432)
183. long jump (831)
184. lunge (759)
185. making a cake (463)
186. making a sandwich (440)
187. making bed (679)
188. making jewelry (658)
189. making pizza (1147)
190. making snowman (756)
191. making sushi (434)
192. making tea (426)
193. marching (1146)
194. massaging back (1113)
195. massaging feet (478)
196. massaging legs (592)
197. massaging person (672)
198. milking cow (980)
199. mopping ﬂoor (606)
200. motorcycling (1142)
201. moving furniture (426)
202. mowing lawn (1147)
203. news anchoring (420)
204. opening bottle (732)
205. opening present (866)
206. paragliding (800)
207. parasailing (762)
208. parkour (504)
209. passing American football (in game) (863)
210. passing American football (not in game) (1045)
211. peeling apples (592)
212. peeling potatoes (457)
213. petting animal (not cat) (757)
214. petting cat (756)
215. picking fruit (793)
216. planting trees (557)
217. plastering (428)
218. playing accordion (925)
219. playing badminton (944)
220. playing bagpipes (838)
221. playing basketball (1144)
222. playing bass guitar (1135)
223. playing cards (737)
224. playing cello (1081)
225. playing chess (850)
226. playing clarinet (1022)
227. playing controller (524)
228. playing cricket (949)
229. playing cymbals (636)
230. playing didgeridoo (787)
231. playing drums (908)
232. playing ﬂute (475)
233. playing guitar (1135)
234. playing harmonica (1006)
235. playing harp (1149)
236. playing ice hockey (917)
237. playing keyboard (715)
238. playing kickball (468)
239. playing monopoly (731)
240. playing organ (672)
241. playing paintball (1140)
242. playing piano (691)
243. playing poker (1134)
244. playing recorder (1148)
245. playing saxophone (916)
246. playing squash or racquetball (980)
247. playing tennis (1144)
248. playing trombone (1149)
249. playing trumpet (989)
250. playing ukulele (1146)
251. playing violin (1142)
252. playing volleyball (804)
253. playing xylophone (746)
254. pole vault (984)
255. presenting weather forecast (1050)
256. pull ups (1121)
257. pumping ﬁst (1009)
258. pumping gas (544)
259. punching bag (1150)
260. punching person (boxing) (483)
261. push up (614)
262. pushing car (1069)
263. pushing cart (1150)
264. pushing wheelchair (465)
265. reading book (1148)
266. reading newspaper (424)
267. recording music (415)
268. riding a bike (476)
269. riding camel (716)
270. riding elephant (1104)
271. riding mechanical bull (698)
272. riding mountain bike (495)
273. riding mule (476)
274. riding or walking with horse (1131)
275. riding scooter (674)
276. riding unicycle (864)
277. ripping paper (605)
278. robot dancing (893)
279. rock climbing (1144)
280. rock scissors paper (424)
281. roller skating (960)
282. running on treadmill (428)
283. sailing (867)
284. salsa dancing (1148)
285. sanding ﬂoor (574)
286. scrambling eggs (816)
287. scuba diving (968)
288. setting table (478)
289. shaking hands (640)
290. shaking head (885)
291. sharpening knives (424)
292. sharpening pencil (752)
293. shaving head (971)
294. shaving legs (509)
295. shearing sheep (988)
296. shining shoes (615)
297. shooting basketball (595)
298. shooting goal (soccer) (444)
299. shot put (987)
300. shoveling snow (879)
301. shredding paper (403)
302. shufﬂing cards (828)
303. side kick (991)
304. sign language interpreting (446)
305. singing (1147)
306. situp (817)
307. skateboarding (1139)
308. ski jumping (1051)
309. skiing (not slalom or crosscountry) (1140)
310. skiing crosscountry (477)
311. skiing slalom (539)
312. skipping rope (488)
313. skydiving (505)
314. slacklining (790)
315. slapping (465)
316. sled dog racing (775)
317. smoking (1105)
318. smoking hookah (857)
319. snatch weight lifting (943)
320. sneezing (505)
321. snifﬁng (399)
322. snorkeling (1012)
323. snowboarding (937)
324. snowkiting (1145)
325. snowmobiling (601)
326. somersaulting (993)
327. spinning poi (1134)
328. spray painting (908)
329. spraying (470)
330. springboard diving (406)
331. squat (1148)
332. sticking tongue out (770)
333. stomping grapes (444)
334. stretching arm (718)
335. stretching leg (829)
336. strumming guitar (472)
337. surﬁng crowd (876)
338. surﬁng water (751)
339. sweeping ﬂoor (604)
340. swimming backstroke (1077)
341. swimming breast stroke (833)
342. swimming butterﬂy stroke (678)
343. swing dancing (512)
344. swinging legs (409)
345. swinging on something (482)
346. sword ﬁghting (473)
347. tai chi (1070)
348. taking a shower (378)
349. tango dancing (1114)
350. tap dancing (947)
351. tapping guitar (815)
352. tapping pen (703)
353. tasting beer (588)
354. tasting food (613)
355. testifying (497)
356. texting (704)
357. throwing axe (816)
358. throwing ball (634)
359. throwing discus (1104)
360. tickling (610)
361. tobogganing (1147)
362. tossing coin (461)
363. tossing salad (463)
364. training dog (481)
365. trapezing (786)
366. trimming or shaving beard (981)
367. trimming trees (665)
368. triple jump (784)
369. tying bow tie (387)
370. tying knot (not on a tie) (844)
371. tying tie (673)
372. unboxing (858)
373. unloading truck (406)
374. using computer (937)
375. using remote controller (not gaming) (549)
376. using segway (387)
377. vault (562)
378. waiting in line (430)
379. walking the dog (1145)
380. washing dishes (1048)
381. washing feet (862)
382. washing hair (423)
383. washing hands (916)
384. water skiing (763)
385. water sliding (420)
386. watering plants (680)
387. waxing back (537)
388. waxing chest (760)
389. waxing eyebrows (720)
390. waxing legs (948)
391. weaving basket (743)
392. welding (759)
393. whistling (416)
394. windsurﬁng (1114)
395. wrapping present (861)
396. wrestling (488)
397. writing (735)
398. yawning (398)
399. yoga (1140)
400. zumba (1093)

  """)
form = st.form(key='form')
form.caption("""
How to use:
1. Choose any youtube video and copy and paste its link into the text field below. \n 
2. Click predict button and the model will recognise the action in the video
""")
output = st.container()
_,video_container, _ = output.columns([1,3,1])

def predict(video_path):
  # video clip consists of 300 frames (10 seconds at 30 FPS)
  vr = VideoReader(video_path, num_threads=1, ctx=cpu(0)) 

  def sample_frame_indices(clip_len, frame_sample_rate, seg_len):
    # As the model only allow 16 frames as input
    # we will sample 16 frames from the video

    # get the total number of frames that our sample would span across
    converted_len = int(clip_len * frame_sample_rate)
    # get a randomised max frame of the video. This would be the last frame out of the 16 frame
    end_idx = np.random.randint(converted_len, seg_len)
    # get the first frame sample
    str_idx = end_idx - converted_len
    # evenly space out the frame between the start and end frame according to the frame sample rate
    index = np.linspace(str_idx, end_idx, num=clip_len)
    # ensure frames' index is within range and convert to numpy array
    index = np.clip(index, str_idx, end_idx - 1).astype(np.int64)

    # # we change the linspace to be spread from 20 to 80 percentile to capture more info across the video
    # index = np.linspace(seg_len*0.2, seg_len*0.8, num=clip_len)
    # index = np.clip(index, seg_len*0.2, seg_len*0.8 - 1).astype(np.int64)
    return index

  # we run vr.seek(0) to start the read
  vr.seek(0)
  # get the np array of frames
  index = sample_frame_indices(clip_len=16, frame_sample_rate=5, seg_len=len(vr))
  # get the frame rgb values as numpy (16 frames, height, width, rgb)
  buffer = vr.get_batch(index).asnumpy()

  # Prepare frames for feature extraction
  video = [buffer[i] for i in range(buffer.shape[0])]

  # extract features based on previous pipeline
  encoding = feature_extractor(video, return_tensors="pt")
  print(encoding.pixel_values.shape)

  pixel_values = encoding.pixel_values.to(device)

  # forward pass
  with torch.no_grad():
    outputs = model(pixel_values)
    logits = outputs.logits

  predicted_class_idx = logits.argmax(-1).item()

  return model.config.id2label[predicted_class_idx]




# form
url = form.text_input("Enter a youtube url. (youtube shorts included)", value = 'https://www.youtube.com/shorts/XlBaKlUdYik')
submit_form = form.form_submit_button(label = "Predict!")



if submit_form:
    with st.spinner('Downloading video'):
      # Download youtube video in specified format
      url = url.replace('shorts/','watch?v=')
      ydl_opts = {
        'format':'mp4[width<=?360][height<=?360]',
        'noplaylist': True,
        'outtmpl': 'test.mp4',
        'cachedir':False
        }
      ydl = youtube_dl.YoutubeDL(ydl_opts)
      try:
        os.remove('./test.mp4')
      except:
        pass
      finally:
        ydl.download([url])

      # Make predictions
      result = predict("test.mp4")

      # display video
      video_container.write("Output")
      video_container.video('test.mp4', format="video/mp4", start_time=0) 
      video_container.write(f"Video is showing someone **{result}**")

